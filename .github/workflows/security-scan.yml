name: Security Scan

on:
  push:
    branches: [main]
    paths: ['frontend/**', 'backend/**']

  pull_request:
    branches: [main]
    paths: ['frontend/**', 'backend/**']

permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        
    - name: Pull images for scanning
      run: |
        # Pull the images that passed E2E tests
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest
        
    - name: Scan backend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest'
        format: 'sarif'
        output: 'trivy-backend-results.sarif'
        trivy-config: '--skip-version-check'
        
    - name: Scan frontend image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        trivy-config: '--skip-version-check'
        
    - name: Upload backend security results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-backend-results.sarif'
        category: 'backend-container'
        wait-for-processing: true
        
    - name: Upload frontend security results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: 'frontend-container' 
        wait-for-processing: true 