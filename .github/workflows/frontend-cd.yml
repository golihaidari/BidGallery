name: Frontend CD

on:
  push:
    branches: [main]
    paths: ['frontend/**']

permissions:
  security-events: write
  actions: read
  contents: read

jobs:
  frontend-security-scan:
    runs-on: ubuntu-latest
    outputs:
      scan-result: ${{ steps.set-result.outputs.scan-result }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Pull frontend image
      run: |
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest
        
    - name: Scan frontend image
      id: scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest'
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        
    - name: Upload security results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: 'frontend-container'

    - name: Set scan result
      id: set-result
      run: |
        if [ "${{ steps.scan.outcome }}" == "success" ]; then
          echo "scan-result=success" >> $GITHUB_OUTPUT
        else
          echo "scan-result=failed" >> $GITHUB_OUTPUT
        fi

  frontend-deploy:
    needs: frontend-security-scan
    if: needs.frontend-security-scan.outputs.scan-result == 'success'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Frontend to CapRover
      run: |
        echo "Frontend team deploying..."
        
        # Login to CapRover
        LOGIN_RESPONSE=$(curl -s -X POST \
          "${{ secrets.CAPROVER_URL }}/api/v2/login" \
          -H "Content-Type: application/json" \
          -d "{\"password\": \"${{ secrets.CAPROVER_PASSWORD }}\"}")
        
        TOKEN=$(echo $LOGIN_RESPONSE | grep -o '"token":"[^"]*' | cut -d'"' -f4)
        
        # Deploy frontend
        DEPLOY_RESPONSE=$(curl -s -X POST \
          "${{ secrets.CAPROVER_URL }}/api/v2/user/apps/appData/frontend" \
          -H "Content-Type: application/json" \
          -H "x-captain-auth: $TOKEN" \
          -d '{
            "imageName": "${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest",
            "instanceCount": 1,
            "notExposeAsWebApp": false,
            "containerHttpPort": 80,
            "captainDefinitionContent": "{\n  \"schemaVersion\": 2,\n  \"imageName\": \"${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest\"\n}"
          }')
        
        echo "Frontend deployment triggered: $DEPLOY_RESPONSE"

  frontend-smoke-test:
    needs: frontend-deploy
    runs-on: ubuntu-latest
    steps:
    - name: Wait for frontend to be ready
      run: |
        echo "Waiting for frontend deployment..."
        MAX_RETRIES=12
        RETRY_COUNT=0
        
        until curl -f https://frontend.bidgallery.publicvm.com/; do
          RETRY_COUNT=$((RETRY_COUNT+1))
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Frontend health check failed after $MAX_RETRIES attempts"
            exit 1
          fi
          echo "Frontend not ready yet, retrying in 10 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
          sleep 10
        done
        echo "Frontend is healthy!"