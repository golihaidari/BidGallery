name: Backend CD

on:
  push:
    branches: [main]
    paths: ['backend/**']  # Only trigger on backend changes

jobs:
  backend-security-scan:
    runs-on: ubuntu-latest
    outputs:
      scan-result: ${{ steps.scan.outputs.result }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Pull backend image
      run: |
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest
        
    - name: Scan backend image
      id: scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest'
        format: 'sarif'
        output: 'trivy-backend-results.sarif'
        
    - name: Upload security results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-backend-results.sarif'
        category: 'backend-container'

    - name: Set scan result
      if: steps.scan.outcome == 'success'
      run: echo "result=success" >> $GITHUB_OUTPUT
      shell: bash

  backend-deploy:
    needs: backend-security-scan
    if: needs.backend-security-scan.outputs.scan-result == 'success'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Backend to CapRover
      run: |
        echo "Backend team deploying..."
        
        # Login to CapRover
        LOGIN_RESPONSE=$(curl -s -X POST \
          "${{ secrets.CAPROVER_URL }}/api/v2/login" \
          -H "Content-Type: application/json" \
          -d "{\"password\": \"${{ secrets.CAPROVER_PASSWORD }}\"}")
        
        TOKEN=$(echo $LOGIN_RESPONSE | grep -o '"token":"[^"]*' | cut -d'"' -f4)
        
        # Deploy backend
        DEPLOY_RESPONSE=$(curl -s -X POST \
          "${{ secrets.CAPROVER_URL }}/api/v2/user/apps/appData/backend" \
          -H "Content-Type: application/json" \
          -H "x-captain-auth: $TOKEN" \
          -d '{
            "imageName": "${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest",
            "instanceCount": 1,
            "notExposeAsWebApp": false,
            "containerHttpPort": 8080,
            "captainDefinitionContent": "{\n  \"schemaVersion\": 2,\n  \"imageName\": \"${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest\"\n}"
          }')
        
        echo "Backend deployment triggered: $DEPLOY_RESPONSE"

  backend-smoke-test:
    needs: backend-deploy
    runs-on: ubuntu-latest
    steps:
    - name: Wait for backend to be ready
      run: |
        echo "Waiting for backend deployment..."
        MAX_RETRIES=12
        RETRY_COUNT=0
        
        until curl -f https://backend.bidgallery.publicvm.com/actuator/health; do
          RETRY_COUNT=$((RETRY_COUNT+1))
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Backend health check failed after $MAX_RETRIES attempts"
            exit 1
          fi
          echo "Backend not ready yet, retrying in 10 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
          sleep 10
        done
        echo "Backend is healthy!"