# e2e.yml
name: E2E Tests

on:
  push:
    branches: [staging]
    paths: ['frontend/**', 'backend/**']

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Pull images from Docker Hub
      run: |
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest

    - name: Create docker-compose for E2E with pulled images
      run: |
        cat > docker-compose.e2e.yml << EOF
        version: '3.8'
        services:
          frontend:
            image: ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-frontend:latest
            ports:
              - "5173:80"
            environment:
              - VITE_API_URL=http://backend:8080/api
            depends_on:
              - backend

          backend:
            image: ${{ secrets.DOCKERHUB_USERNAME }}/bidgallery-backend:latest
            ports:
              - "8080:8080"
            environment:
              - SPRING_PROFILES_ACTIVE=development
              - SPRING_DATASOURCE_URL=jdbc:mariadb://database:3306/bidgallery
              - SPRING_DATASOURCE_USERNAME=admin
              - SPRING_DATASOURCE_PASSWORD=password
            depends_on:
              - database

          database:
            image: mariadb:10.11
            environment:
              MYSQL_ROOT_PASSWORD: root
              MYSQL_DATABASE: bidgallery
              MYSQL_USER: admin
              MYSQL_PASSWORD: password
        EOF

    - name: Start services for E2E tests
      run: |
        docker-compose -f docker-compose.e2e.yml up -d
        sleep 30
        docker-compose -f docker-compose.e2e.yml ps

    - name: Run Cypress tests
      run: |
        cd e2e
        npm ci
        npx cypress run --config baseUrl=http://localhost:5173
        
    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.e2e.yml down -v