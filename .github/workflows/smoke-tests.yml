name: Global Smoke Tests

on:
  workflow_run:
    workflows: ["Backend CD", "Frontend CD"]
    types: [completed]

jobs:
  global-smoke-tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Test cross-service integration
      run: |
        echo "Testing cross-service integration..."
        
        # Test 1: Backend APIs are accessible from "outside"
        echo "Testing backend APIs..."
        curl -f https://backend.bidgallery.publicvm.com/api/products > /dev/null
        echo "Products API accessible"
        
        curl -f https://backend.bidgallery.publicvm.com/api/auth/health > /dev/null
        echo "Auth API accessible"
        
        # Test 2: Frontend can communicate with backend (simulate real usage)
        echo "Testing frontend-backend connectivity..."
        
        # Test that critical API endpoints return valid data
        API_RESPONSE=$(curl -s https://backend.bidgallery.publicvm.com/api/products)
        if echo "$API_RESPONSE" | grep -q "id"; then
          echo "Products API returns valid data"
        else
          echo "Products API returned unexpected response"
          exit 1
        fi
        
        # Test 3: Verify authentication flow works
        AUTH_RESPONSE=$(curl -s https://backend.bidgallery.publicvm.com/api/auth/health)
        if echo "$AUTH_RESPONSE" | grep -q "UP\|OK"; then
          echo "Auth service healthy"
        else
          echo "Auth service issues"
          exit 1
        fi
        
        echo "All cross-service integration tests passed!"

    - name: Test business workflows
      run: |
        echo "Testing critical business workflows..."
        
        # Test that bidding/ordering APIs are functional
        # (These are more complex than basic health checks)
        curl -f https://backend.bidgallery.publicvm.com/api/checkout/health > /dev/null
        echo "Checkout service available"
        
        # Test that the frontend loads with dynamic content
        FRONTEND_RESPONSE=$(curl -s https://frontend.bidgallery.publicvm.com/)
        if echo "$FRONTEND_RESPONSE" | grep -q "BidGallery"; then
          echo "Frontend loaded successfully"
        else
          echo "Frontend content issue"
          exit 1
        fi
        
        echo "Critical business workflows verified"