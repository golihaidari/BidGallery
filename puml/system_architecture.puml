@startuml system_architecture

!define DOCKER <img:https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/devicons/docker.png>
!define RECTANGLE class
skinparam defaultFontName Arial
skinparam roundCorner 10
skinparam classBackgroundColor White
skinparam classBorderColor Black
skinparam shadowing false

top to bottom direction

actor "a) User" as user #LightBlue 

rectangle "b) Client Browser\n(React SPA)" as browser #LightBlue
cloud "DigitalOcean Cloud" #LightGray {
  rectangle "c) Ubuntu Server + docker Engine" #LightSteelBlue {

      rectangle "c1) CapRover Platform üê≥" as caprover #LightCyan {
        rectangle "NGINX üê≥\n(CapRover Reverse Proxy & Load Balancer)\n*.bidgallery.publicvm.com" as nginx #Pink
      }

      package "c2) Frontend App" as frontend_package #LightCyan{
          rectangle "React + TS üê≥\n(Vite Build)" as fe #Pink
      }

      package "c3) Backend API" as backend_package #LightCyan{
        node "Spring Boot + Embeded Tomcat 1..N üê≥\nhttps://backend.bidgallery.publicvm.com" as api #Pink
      }

      package "c4) Database Stack" as database_package #LightCyan{
          database "MariaDB üê≥\nsrv-captain--database-db\nUsers, Artists, Products, Orders" as db #Pink
          rectangle "phpMyAdmin üê≥" as phpmyadmin #Pink
      }
      
      package "c5) Monitoring Apps" as monitoring_package #LightCyan{
          rectangle "Loki  üê≥" as loki #Pink
          rectangle "Prometheus üê≥" as prometheus  #Pink
          rectangle "Grafana üê≥" as grafana #Pink
          rectangle "Promtail üê≥\n(Log Collector)" as promtail #Pink
      }
      
      
  }
}

package "d) External Services" #LightBlue {
    rectangle "d1) Payment API" as payment #Pink
    rectangle "d2) OAuth API" as auth #Pink
}


' --- CORRECT FLOW ---
user --> browser
browser --> nginx : "HTTPS Request\n*.bidgallery.publicvm.com"
nginx -> fe : "GET /\nReact App (Static)"
nginx --> api : "API Calls /api/*\nLoad Balanced"
nginx --> grafana : "GET /grafana\nDashboard Access"
nginx --> prometheus : "GET /prometheus \nAccess Metrics"
nginx -right-> phpmyadmin : "Database Access"

fe --> nginx : "API Proxy Calls\n/api/*"

' Database & Backend
api -right-> db : "SQL Queries"
phpmyadmin --> db : "Database Admin"

' --- CORRECT OBSERVABILITY FLOW ---
promtail -up-> loki : "Collects & Sends\nContainer Logs"
api --> prometheus : "Exposes Metrics\n/actuator/prometheus"
prometheus -down-> grafana : "Provides Metrics\nfor Dashboards"
loki --> grafana : "Provides Logs\nfor Analysis"

' External Services
api --> payment : "Payment Processing\nPOST paymentsIntent"
api --> auth : "OAuth Flow\nPOST /verify user token"

' Additional notes for clarity
note left of api
  **API Endpoints:**
  ‚Ä¢ Swagger: /swagger-ui/index.html
  ‚Ä¢ Authentication: /api/auth/**
  ‚Ä¢ Products: /api/products/**
  ‚Ä¢ Bidding: /api/checkout/placebid
  ‚Ä¢ Orders: /api/checkout/placeorder
  ‚Ä¢ Health: /actuator/health
  ‚Ä¢ Metrics: /actuator/prometheus
end note

note right of nginx
  **CapRover Management:**
  ‚Ä¢ Container orchestration
  ‚Ä¢ SSL certificate management
  ‚Ä¢ Load balancing

  **CapRover NGINX Routes:**
  ‚Ä¢ frontend.bidgallery.publicvm.com ‚Üí React App
  ‚Ä¢ backend.bidgallery.publicvm.com ‚Üí Spring Boot API
  ‚Ä¢ grafana.bidgallery.publicvm.com ‚Üí Grafana
  ‚Ä¢ prometheus.bidgallery.publicvm.com ‚Üí Prometheus
  ‚Ä¢ loki.bidgallery.publicvm.com ‚Üí Loki
  ‚Ä¢ phpmyadmin.bidgallery.publicvm.com ‚Üí phpMyAdmin
end note



note left of promtail
  **Promtail collects from:**
  ‚Ä¢ All container logs üê≥
  ‚Ä¢ Docker JSON log files
  ‚Ä¢ Automatic service discovery
  ‚Ä¢ Sends to Loki via HTTP
end note

